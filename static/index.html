<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fishing TPA</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://sad.adsgram.ai/js/sad.min.js"></script>
    <style>
        /* --- –°–¢–ò–õ–ò (DESIGN) --- */
        :root { 
            --blue: #3b82f6; --gold: #facc15; --green: #22c55e; --red: #ef4444; 
            --glass-bg: rgba(15, 23, 42, 0.95); 
            --glass-border: 1px solid rgba(255, 255, 255, 0.12); 
            --content-width: 94%; 
        }
        
        body { 
            background: url('/static/images/bg.jpg') center/cover no-repeat, linear-gradient(180deg, #0f172a 0%, #1e3a8a 100%);
            color: #f1f5f9; 
            font-family: 'SF Pro Display', 'Segoe UI', Roboto, Helvetica, sans-serif; 
            margin: 0; height: 100vh; display: flex; flex-direction: column; 
            user-select: none; overflow: hidden; -webkit-tap-highlight-color: transparent; 
        }

        /* --- –®–ê–ü–ö–ê --- */
        .header { 
            padding: 15px; text-align: center; 
            background: linear-gradient(180deg, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%); 
            position: relative; z-index: 50; 
            min-height: 20px; 
            flex-shrink: 0;
        }

        .top-controls { 
            position: absolute; top: 15px; width: 100%; display: flex; justify-content: space-between; 
            padding: 0 15px; box-sizing: border-box; pointer-events: none; z-index: 20; 
        }
        .lang-switch { display: flex; gap: 8px; pointer-events: auto; }
        .flag-img { width: 28px; height: 21px; border-radius: 6px; cursor: pointer; opacity: 0.8; transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.2); }
        .flag-img.active { opacity: 1; transform: scale(1.1); border-color: #fff; box-shadow: 0 0 8px rgba(255,255,255,0.4); }
        .sound-btn { background: rgba(0,0,0,0.6); border: 1px solid rgba(255,255,255,0.2); color: white; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; pointer-events: auto; backdrop-filter: blur(5px); display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }

        .balance-container { margin-top: 50px; text-shadow: 0 4px 15px rgba(0,0,0,0.8); transition: opacity 0.3s; }
        .balance { 
            font-family: 'Arial Rounded MT Bold', 'Verdana', sans-serif; 
            font-size: 3.2rem; font-weight: 900; color: var(--gold); line-height: 1;
            -webkit-text-stroke: 1px rgba(0,0,0,0.3); text-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }
        .balance-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 3px; opacity: 0.9; font-weight: 700; margin-bottom: 5px; color: #e2e8f0; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }

        /* --- –ö–û–ù–¢–ï–ù–¢ --- */
        .content { 
            flex: 1; display: none; flex-direction: column; align-items: center; 
            width: 100%; position: relative; overflow: hidden; 
            padding-bottom: 105px; 
            box-sizing: border-box;
        }
        .active-page { display: flex; } 
        #page-game { justify-content: center; }

        /* --- –ò–ì–†–ê --- */
        .game-area { 
            position: relative; display: flex; flex-direction: column; align-items: center; 
            width: 100%; justify-content: center; flex: 1;
        }
        
        .fish-btn { 
            width: 220px; height: 220px; 
            max-width: 35vh; max-height: 35vh;
            border-radius: 50%; 
            background: url('/static/images/float.png') center/contain no-repeat;
            filter: drop-shadow(0 20px 50px rgba(0,0,0,0.5));
            cursor: pointer; transition: transform 0.1s; z-index: 10; position: relative;
            display: flex; justify-content: center; align-items: flex-end; 
            margin-bottom: 10px;
        }
        .fish-btn:active { transform: scale(0.94); }
        .fish-btn::after {
            content: ''; position: absolute; width: 180px; height: 180px; bottom: 10px; left: 50%; margin-left: -90px;
            border-radius: 50%; border: 1px solid rgba(255, 255, 255, 0.3);
            animation: ripple 2s infinite; z-index: -1; opacity: 0; pointer-events: none;
        }
        @keyframes ripple { 0% { transform: scale(0.8); opacity: 0.6; } 100% { transform: scale(1.6); opacity: 0; } }

        .energy-wrapper { 
            width: 220px; text-align: center; margin-top: 15px; 
            background: rgba(0,0,0,0.6); padding: 8px 12px; border-radius: 40px; 
            backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); 
            flex-shrink: 0; 
        }
        .energy-box { width: 100%; height: 8px; background: rgba(255,255,255,0.15); border-radius: 4px; overflow: hidden; margin-bottom: 4px; }
        .energy-fill { height: 100%; width: 100%; background: linear-gradient(90deg, #3b82f6, #60a5fa); transition: width 0.3s; box-shadow: 0 0 10px rgba(59, 130, 246, 0.6); }
        .energy-text { font-size: 0.75rem; color: #fff; font-weight: 700; letter-spacing: 0.5px; }

        /* --- –ú–ê–ì–ê–ó–ò–ù --- */
        #page-shop { 
            height: 100%; 
            padding-top: 20px; 
            justify-content: flex-start;
        }

        .shop-panel {
            width: 94%;
            flex: 1; 
            background: var(--glass-bg); 
            backdrop-filter: blur(15px);
            border-radius: 24px;
            border: var(--glass-border);
            padding: 20px 15px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            min-height: 0; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); 
        }

        .top-header {
            color: #fff; 
            margin: 0 0 15px 0; 
            text-transform: uppercase; letter-spacing: 2px; font-weight: 900; font-size: 1.1rem;
            text-align: center;
            text-shadow: 0 2px 10px rgba(255,255,255,0.2);
            flex-shrink: 0;
        }

        .shop-inventory {
            display: flex; justify-content: center; gap: 15px; margin-bottom: 15px; flex-shrink: 0;
        }
        .inv-item {
            background: rgba(255,255,255,0.1); border-radius: 12px; padding: 6px 12px;
            display: flex; align-items: center; gap: 6px; font-size: 0.9rem; font-weight: 700; color: #cbd5e1;
        }

        .shop-list { 
            width: 100%; 
            flex: 1; 
            overflow-y: auto; 
            display: flex; flex-direction: column; gap: 8px; 
            padding-right: 2px;
            padding-bottom: 10px;
            -webkit-overflow-scrolling: touch;
        }
        
        .shop-list::-webkit-scrollbar { width: 5px; display: block; }
        .shop-list::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); border-radius: 3px; }
        .shop-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 3px; }

        .card { 
            background: rgba(30, 41, 59, 0.7); 
            width: 100%; 
            padding: 14px 16px; 
            border-radius: 16px; 
            display: flex; align-items: center; 
            border: 1px solid rgba(255,255,255,0.08); 
            box-sizing: border-box;
            flex-shrink: 0;
        }
        .card:active { transform: scale(0.98); }
        .card-icon { font-size: 2rem; margin-right: 15px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)); }
        .card-info { flex: 1; }
        .card-title { font-weight: 800; font-size: 1rem; color: #fff; }
        .card-sub { font-size: 0.8rem; color: #94a3b8; margin-top: 3px; font-weight: 600; }
        
        .btn { background: var(--blue); color: white; border: none; padding: 10px 14px; border-radius: 10px; font-weight: 800; font-size: 0.8rem; box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3); text-transform: uppercase; min-width: 70px; }
        .btn:disabled { background: #334155; opacity: 0.6; box-shadow: none; color: #64748b; pointer-events: none; }
        .btn-ad { background: var(--green); color: white; border: none; padding: 10px 14px; border-radius: 10px; font-weight: 800; font-size: 0.8rem; animation: pulse 2s infinite; cursor: pointer; box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3); text-transform: uppercase; min-width: 70px; }

        .shop-footer-balance {
            margin-top: 15px;
            font-size: 1rem;
            color: var(--gold);
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            flex-shrink: 0;
            text-align: center;
            text-shadow: 0 0 10px rgba(250, 204, 21, 0.3);
        }

        /* --- –≠–§–§–ï–ö–¢–´ --- */
        .float-text { position: absolute; font-weight: 900; font-size: 2rem; pointer-events: none; animation: floatUp 0.8s forwards; z-index: 100; white-space: nowrap; text-shadow: 0 4px 10px rgba(0,0,0,0.8); -webkit-text-stroke: 1px rgba(0,0,0,0.2); }
        @keyframes floatUp { 0% { opacity: 0; transform: translateY(20px) scale(0.5); } 20% { opacity: 1; transform: translateY(0) scale(1.2); } 100% { opacity: 0; transform: translateY(-100px) scale(1); } }

        /* --- POPUP (–ò–ó–ú–ï–ù–ï–ù) --- */
        .catch-popup {
            position: fixed !important; 
            top: 50% !important; 
            left: 50% !important; 
            transform: translate(-50%, -50%) scale(0.8) !important;
            background: rgba(15, 23, 42, 0.98); 
            border: 1px solid var(--gold);
            padding: 30px; 
            border-radius: 28px; 
            text-align: center; 
            z-index: 1000 !important; 
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            pointer-events: none; 
            opacity: 0; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.9);
            width: 75%;
            max-width: 320px;
        }
        .catch-popup.show { 
            transform: translate(-50%, -50%) scale(1) !important; 
            opacity: 1 !important; 
            pointer-events: auto !important; /* –í–∫–ª—é—á–∞–µ–º –∫–ª–∏–∫–∏ */
        }
        .catch-img { width: 120px; height: 120px; object-fit: contain; margin-bottom: 15px; filter: drop-shadow(0 10px 30px rgba(0,0,0,0.6)); }
        .catch-title { font-size: 1.4rem; font-weight: 900; color: white; margin-bottom: 8px; letter-spacing: 0.5px; }
        .catch-reward { font-size: 1.6rem; font-weight: 800; color: var(--gold); }

        .popup-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn-claim {
            background: var(--gold);
            color: #0f172a;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 900;
            font-size: 1rem;
            text-transform: uppercase;
            box-shadow: 0 4px 15px rgba(250, 204, 21, 0.4);
            cursor: pointer;
        }

        .btn-share {
            background: var(--blue);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 900;
            font-size: 1rem;
            text-transform: uppercase;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
            cursor: pointer;
        }

        /* --- –ù–ò–ñ–ù–ï–ï –ú–ï–ù–Æ --- */
        .nav { 
            height: 85px; width: 100%; background: rgba(15, 23, 42, 0.98); 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            display: flex; justify-content: space-around; align-items: center; 
            border-top: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; z-index: 100; 
            padding-bottom: 15px; padding-top: 12px; box-sizing: border-box; 
            position: fixed; bottom: 0; left: 0; 
        }
        .nav-item { color: #64748b; font-size: 0.7rem; display: flex; flex-direction: column; align-items: center; padding: 0; transition: 0.2s; width: 60px; font-weight: 700; justify-content: center; letter-spacing: 0.5px; }
        .nav-item.active { color: var(--blue); transform: translateY(-3px); text-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
        
        /* --- –¢–û–ü --- */
        #page-top { 
            height: 100%; 
            padding-top: 20px; 
            box-sizing: border-box; display: none; flex-direction: column; align-items: center; justify-content: flex-start; 
        }
        .leaderboard-panel { width: 94%; flex: 1; background: var(--glass-bg); backdrop-filter: blur(15px); border-radius: 24px; border: var(--glass-border); padding: 20px 15px; box-sizing: border-box; display: flex; flex-direction: column; min-height: 0; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
        .tabs-container { width: 100%; display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; flex-shrink: 0; }
        .tabs-row { display: flex; justify-content: space-between; background: rgba(0, 0, 0, 0.4); border-radius: 12px; padding: 4px; border: 1px solid rgba(255,255,255,0.05); }
        .tab { flex: 1; text-align: center; padding: 8px 0; font-size: 0.8rem; border-radius: 10px; cursor: pointer; color: #94a3b8; font-weight: 700; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .tab.active { background: var(--blue); color: white; box-shadow: 0 2px 10px rgba(59, 130, 246, 0.4); }
        
        .leaderboard-list { 
            width: 100%; flex: 1; overflow-y: auto; 
            display: flex; flex-direction: column; gap: 0; 
            border-top: 1px solid rgba(255,255,255,0.05); border-bottom: 1px solid rgba(255,255,255,0.05); 
            -webkit-overflow-scrolling: touch;
            padding-bottom: 10px;
        }
        .leaderboard-list::-webkit-scrollbar { width: 5px; display: block; }
        .leaderboard-list::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); border-radius: 3px; }
        .leaderboard-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 3px; }

        .leader-row { display: flex; justify-content: space-between; align-items: center; padding: 14px 8px; border-bottom: 1px solid rgba(255,255,255,0.08); font-weight: 600; font-size: 0.95rem; color: #f1f5f9; flex-shrink: 0; }
        .leader-row:last-child { border-bottom: none; }
        .leader-left { display: flex; align-items: center; gap: 12px; }
        .leader-rank { width: 26px; height: 26px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.1); border-radius: 6px; font-size: 0.8rem; color: #94a3b8; font-weight: 800; }
        .leader-val { color: var(--gold); text-align: right; font-weight: 800; font-family: 'Segoe UI', sans-serif; }
        .rank-1 .leader-rank { background: none; font-size: 1.5rem; text-shadow: 0 0 15px rgba(250, 204, 21, 0.5); }
        .rank-1 { color: #facc15; text-shadow: 0 0 10px rgba(250, 204, 21, 0.2); }
        .rank-2 .leader-rank { background: none; font-size: 1.5rem; text-shadow: 0 0 15px rgba(203, 213, 225, 0.5); }
        .rank-2 { color: #e2e8f0; }
        .rank-3 .leader-rank { background: none; font-size: 1.5rem; text-shadow: 0 0 15px rgba(251, 146, 60, 0.5); }
        .rank-3 { color: #fdba74; }
        .total-players { margin-top: 15px; font-size: 0.75rem; color: #64748b; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8; flex-shrink: 0; text-align: center; }
    </style>
</head>
<body>
    <audio id="bg-music" loop> <source src="/static/music.wav" type="audio/wav"> </audio>
    <audio id="sfx-catch"> <source src="/static/catch.wav" type="audio/wav"> </audio>
    <audio id="sfx-fail"> <source src="/static/fail.wav" type="audio/wav"> </audio>

    <div class="header">
        <div class="top-controls">
            <div class="lang-switch">
                <img src="https://flagcdn.com/32x24/us.png" class="flag-img" id="flag-en" onclick="setLanguage('en')">
                <img src="https://flagcdn.com/32x24/ru.png" class="flag-img" id="flag-ru" onclick="setLanguage('ru')">
                <img src="https://flagcdn.com/32x24/es.png" class="flag-img" id="flag-es" onclick="setLanguage('es')">
                <img src="https://flagcdn.com/32x24/cn.png" class="flag-img" id="flag-zh" onclick="setLanguage('zh')">
            </div>
            <button class="sound-btn" onclick="toggleMute()" id="sound-btn">üéµ</button>
        </div>
        <div class="balance-container" id="main-balance-display">
            <div class="balance-label" data-t="score_label">BALANCE</div>
            <div class="balance" id="balance">0</div>
        </div>
    </div>

    <div id="catch-popup" class="catch-popup">
        <img id="popup-img" class="catch-img" src="" alt="Catch">
        <div id="popup-title" class="catch-title"></div>
        <div id="popup-reward" class="catch-reward"></div>
        <div class="popup-buttons">
            <button class="btn-share" onclick="shareCurrentCatch()" data-t="btn_share">üì§ Share</button>
            <button class="btn-claim" onclick="closePopup()" data-t="btn_claim">üí∞ Claim</button>
        </div>
    </div>

    <div id="page-game" class="content active-page">
        <div class="game-area">
            <div class="fish-btn" id="fish-btn" onclick="catchFish(event)"></div>
            <div class="energy-wrapper">
                <div class="energy-box"><div class="energy-fill" id="energy-fill"></div></div>
                <div class="energy-text" id="energy-text">100% Energy</div>
            </div>
        </div>
    </div>

    <div id="page-shop" class="content">
        <div class="shop-panel">
            <div class="top-header" data-t="shop_title">Equipment Market</div>
            
            <div class="shop-inventory">
                <div class="inv-item">ü™± <span id="inv-bait-common">0</span></div>
                <div class="inv-item">üêü <span id="inv-bait-rare">0</span></div>
            </div>

            <div class="tabs-container">
                <div class="tabs-row">
                    <div class="tab active" onclick="switchShopTab('equip', this)">
                        <span class="tab-icon">üé£</span> <span data-t="shop_equip">Equipment</span>
                    </div>
                    <div class="tab" onclick="switchShopTab('consum', this)">
                        <span class="tab-icon">üß™</span> <span data-t="shop_consum">Consumables</span>
                    </div>
                </div>
            </div>

            <div id="shop-list" class="shop-list"></div>
            
            <div id="shop-balance-footer" class="shop-footer-balance"></div>
        </div>
    </div>

    <div id="page-top" class="content">
        <div class="leaderboard-panel">
            <div class="top-header" data-t="top_title">Hall of Fame</div>
            
            <div class="tabs-container">
                <div class="tabs-row">
                    <div class="tab active" onclick="switchTopType('balance', this)">
                        <span class="tab-icon">üí∞</span> <span data-t="top_rich">Rich</span>
                    </div>
                    <div class="tab" onclick="switchTopType('weight', this)">
                        <span class="tab-icon">‚öñÔ∏è</span> <span data-t="top_fish">Fisher</span>
                    </div>
                    <div class="tab" onclick="switchTopType('trash', this)">
                        <span class="tab-icon">‚ôªÔ∏è</span> <span data-t="top_eco">Eco</span>
                    </div>
                </div>
                
                <div class="tabs-row">
                    <div class="tab" onclick="switchTopPeriod('week', this)"><span data-t="period_week">Week</span></div>
                    <div class="tab" onclick="switchTopPeriod('month', this)"><span data-t="period_month">Month</span></div>
                    <div class="tab" onclick="switchTopPeriod('year', this)"><span data-t="period_year">Year</span></div>
                    <div class="tab active" onclick="switchTopPeriod('all', this)"><span data-t="period_all">All</span></div>
                </div>
            </div>

            <div id="leaderboard-list" class="leaderboard-list"></div>
            <div id="total-players-count" class="total-players"></div>
        </div>
    </div>

    <div class="nav">
        <div class="nav-item active" onclick="tab('game', this)">
            <img src="/static/images/icon_game.png" style="width:48px; height:48px; margin-bottom:4px; object-fit:contain;">
            <span data-t="nav_game">Game</span>
        </div>
        <div class="nav-item" onclick="tab('shop', this)">
            <img src="/static/images/icon_shop.png" style="width:48px; height:48px; margin-bottom:4px; object-fit:contain;">
            <span data-t="nav_shop">Shop</span>
        </div>
        <div class="nav-item" onclick="tab('top', this)">
            <img src="/static/images/icon_top.png" style="width:48px; height:48px; margin-bottom:4px; object-fit:contain;">
            <span data-t="nav_top">Top</span>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const uid = tg.initDataUnsafe.user?.id || 0;
        const uname = tg.initDataUnsafe.user?.username || "Fisher";
        const fname = tg.initDataUnsafe.user?.first_name || "";
        const lname = tg.initDataUnsafe.user?.last_name || "";
        
        let ADSGRAM_BLOCK_ID = null;

        const CONSUMABLES_INFO = {
            'energy_drink': {price: 400, name_key: 'item_energy_drink', desc_key: 'desc_energy', icon: 'ü•§'},
            'bait_common': {price: 100, name_key: 'item_bait_common', desc_key: 'desc_bait_common', icon: 'ü™±'},
            'bait_rare': {price: 800, name_key: 'item_bait_rare', desc_key: 'desc_bait_rare', icon: 'üêü'}
        };

        const translations = {
            en: {
                score_label: "BALANCE", shop_title: "Fishing Market", item_rod: "Spinning Rod", item_boat: "Trawler (AFK)",
                top_title: "Hall of Fame", nav_game: "Game", nav_shop: "Shop", nav_top: "Top",
                no_energy: "No energy üí§", miss: "Missed!", caught: "Caught:", lvl: "Lvl", chance: "Chance",
                none: "None", buy_success: "Purchased!", afk_income: "AFK Income:", coins: "coins", loading: "Loading...",
                ad_title: "Free Energy", ad_desc: "Bonus Coins & Full Energy", ad_btn: "WATCH",
                energy_label: "Energy",
                top_rich: "Rich", top_fish: "Fisher", top_eco: "Eco",
                period_week: "Week", period_month: "Month", period_year: "Year", period_all: "All",
                unit_kg: "kg", unit_pc: "pc.",
                empty_list: "Empty list...", total_players: "Total players:",
                shop_equip: "Equipment", shop_consum: "Consumables",
                item_energy_drink: "Energy Drink", desc_energy: "Restore 50% Energy",
                item_bait_common: "Worms (10x)", desc_bait_common: "+15% Chance",
                item_bait_rare: "Live Bait (5x)", desc_bait_rare: "+35% Chance & Rarer Fish",
                // –ù–û–í–´–ï –ö–ù–û–ü–ö–ò
                btn_share: "üì§ Share", btn_claim: "üí∞ Claim"
            },
            ru: {
                score_label: "–ë–ê–õ–ê–ù–°", shop_title: "–†—ã–±–æ–ª–æ–≤–Ω—ã–π –†—ã–Ω–æ–∫", item_rod: "–°–ø–∏–Ω–Ω–∏–Ω–≥", item_boat: "–¢—Ä–∞—É–ª–µ—Ä (AFK)",
                top_title: "–ó–∞–ª –°–ª–∞–≤—ã", nav_game: "–ò–≥—Ä–∞", nav_shop: "–†—ã–Ω–æ–∫", nav_top: "–¢–æ–ø",
                no_energy: "–ù–µ—Ç —Å–∏–ª üí§", miss: "–°–æ—Ä–≤–∞–ª–∞—Å—å!", caught: "–ü–æ–π–º–∞–Ω:", lvl: "–£—Ä.", chance: "–®–∞–Ω—Å",
                none: "–ù–µ—Ç", buy_success: "–ö—É–ø–ª–µ–Ω–æ!", afk_income: "AFK –¥–æ—Ö–æ–¥:", coins: "–º–æ–Ω–µ—Ç", loading: "–ó–∞–≥—Ä—É–∑–∫–∞...",
                ad_title: "–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –≠–Ω–µ—Ä–≥–∏—è", ad_desc: "–ú–æ–Ω–µ—Ç—ã (–æ—Ç —É—Ä–æ–≤–Ω—è) –∏ —ç–Ω–µ—Ä–≥–∏—è", ad_btn: "–í–ò–î–ï–û",
                energy_label: "–ó–∞–ø–∞—Å —Å–∏–ª",
                top_rich: "–ë–æ–≥–∞—á–∏", top_fish: "–†—ã–±–∞–∫–∏", top_eco: "–≠–∫–æ–ª–æ–≥–∏",
                period_week: "–ù–µ–¥–µ–ª—è", period_month: "–ú–µ—Å—è—Ü", period_year: "–ì–æ–¥", period_all: "–í—Å—ë",
                unit_kg: "–∫–≥", unit_pc: "—à—Ç.",
                empty_list: "–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç...", total_players: "–í—Å–µ–≥–æ –∏–≥—Ä–æ–∫–æ–≤:",
                shop_equip: "–°–Ω–∞—Å—Ç–∏", shop_consum: "–ü—Ä–∏–ø–∞—Å—ã",
                item_energy_drink: "–≠–Ω–µ—Ä–≥–µ—Ç–∏–∫", desc_energy: "–í–æ—Å—Å—Ç. 50% —Å–∏–ª",
                item_bait_common: "–ß–µ—Ä–≤–∏ (10—à—Ç)", desc_bait_common: "+15% –∫ —à–∞–Ω—Å—É",
                item_bait_rare: "–ñ–∏–≤–µ—Ü (5—à—Ç)", desc_bait_rare: "+35% —à–∞–Ω—Å, –ª—É—á—à–µ —É–ª–æ–≤",
                // –ù–û–í–´–ï –ö–ù–û–ü–ö–ò
                btn_share: "üì§ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è", btn_claim: "üí∞ –ó–∞–±—Ä–∞—Ç—å"
            },
            es: {
                score_label: "BALANCE", shop_title: "Mercado de Pesca", item_rod: "Ca√±a de Pescar", item_boat: "Barco (AFK)",
                top_title: "Sal√≥n de la Fama", nav_game: "Juego", nav_shop: "Tienda", nav_top: "Top",
                no_energy: "Sin energ√≠a üí§", miss: "¬°Fallaste!", caught: "Captura:", lvl: "Nvl", chance: "Prob.",
                none: "Ninguno", buy_success: "¬°Comprado!", afk_income: "Ingresos AFK:", coins: "monedas", loading: "Cargando...",
                ad_title: "Energ√≠a Gratis", ad_desc: "Monedas extra y energ√≠a", ad_btn: "VER",
                energy_label: "Energ√≠a",
                top_rich: "Ricos", top_fish: "Pescador", top_eco: "Eco",
                period_week: "Semana", period_month: "Mes", period_year: "A√±o", period_all: "Todo",
                unit_kg: "kg", unit_pc: "pz.",
                empty_list: "Lista vac√≠a...", total_players: "Jugadores totales:",
                shop_equip: "Equipo", shop_consum: "Consumibles",
                item_energy_drink: "Bebida Energ√©tica", desc_energy: "Restaura 50% Energ√≠a",
                item_bait_common: "Gusanos (10x)", desc_bait_common: "+15% Probabilidad",
                item_bait_rare: "Cebo Vivo (5x)", desc_bait_rare: "+35% Prob. & Mejor Pesca",
                // –ù–û–í–´–ï –ö–ù–û–ü–ö–ò
                btn_share: "üì§ Compartir", btn_claim: "üí∞ Recoger"
            },
            zh: {
                score_label: "‰ΩôÈ¢ù", shop_title: "Ê∏îÂÖ∑ÂïÜÂ∫ó", item_rod: "È±ºÁ´ø", item_boat: "Ê∏îËàπ (ÊåÇÊú∫)",
                top_title: "Âêç‰∫∫Â†Ç", nav_game: "ÊçïÈ±º", nav_shop: "ÂïÜÂ∫ó", nav_top: "ÊéíË°å",
                no_energy: "Ê≤°ÊúâËÉΩÈáè üí§", miss: "Ë∑ë‰∫Ü!", caught: "ÈíìÂà∞‰∫Ü:", lvl: "Á≠âÁ∫ß", chance: "Âá†Áéá",
                none: "Êó†", buy_success: "Ë¥≠‰π∞ÊàêÂäü!", afk_income: "Á¶ªÁ∫øÊî∂Áõä:", coins: "ÈáëÂ∏Å", loading: "Âä†ËΩΩ‰∏≠...",
                ad_title: "ÂÖçË¥πËÉΩÈáè", ad_desc: "Â§ßÈáèÈáëÂ∏Å & 100%ËÉΩÈáè", ad_btn: "ËßÇÁúã",
                energy_label: "ËÉΩÈáè",
                top_rich: "ÂØåË±™", top_fish: "Ê∏îÂ§´", top_eco: "ÁîüÊÄÅ",
                period_week: "Âë®", period_month: "Êúà", period_year: "Âπ¥", period_all: "ÊÄªÊ¶ú",
                unit_kg: "kg", unit_pc: "‰∏™",
                empty_list: "ÂàóË°®‰∏∫Á©∫...", total_players: "Áé©ÂÆ∂ÊÄªÊï∞:",
                shop_equip: "Ë£ÖÂ§á", shop_consum: "Ê∂àËÄóÂìÅ",
                item_energy_drink: "ËÉΩÈáèÈ•ÆÊñô", desc_energy: "ÊÅ¢Â§ç 50% ËÉΩÈáè",
                item_bait_common: "Ë†ïËô´ (10‰∏™)", desc_bait_common: "+15% Âá†Áéá",
                item_bait_rare: "Ê¥ªÈ•µ (5‰∏™)", desc_bait_rare: "+35% Âá†Áéá & Á®ÄÊúâÈ±º",
                // –ù–û–í–´–ï –ö–ù–û–ü–ö–ò
                btn_share: "üì§ ÂàÜ‰∫´", btn_claim: "üí∞ È¢ÜÂèñ"
            }
        };

        const fishNames = {
            weed: { en: "Seaweed", ru: "–í–æ–¥–æ—Ä–æ—Å–ª–∏", es: "Algas", zh: "Êµ∑Ëóª" },
            boot: { en: "Old Boot", ru: "–î—ã—Ä—è–≤—ã–π —Å–∞–ø–æ–≥", es: "Bota vieja", zh: "ÊóßÈù¥Â≠ê" },
            tin: { en: "Rusty Can", ru: "–†–∂–∞–≤–∞—è –±–∞–Ω–∫–∞", es: "Lata oxidada", zh: "ÁîüÈîàÁöÑÁΩêÂ§¥" },
            bone: { en: "Fish Bone", ru: "–°–∫–µ–ª–µ—Ç —Ä—ã–±—ã", es: "Espina de pez", zh: "È±ºÈ™®" },
            bag: { en: "Plastic Bag", ru: "–ü–∞–∫–µ—Ç", es: "Bolsa de pl√°stico", zh: "Â°ëÊñôË¢ã" },
            tire: { en: "Old Tire", ru: "–°—Ç–∞—Ä–∞—è —à–∏–Ω–∞", es: "Neum√°tico viejo", zh: "ÊóßËΩÆËÉé" },
            minnow: { en: "Minnow", ru: "–ü–µ—Å–∫–∞—Ä—å", es: "Pececillo", zh: "Â∞èÈ±º" },
            shrimp: { en: "Shrimp", ru: "–ö—Ä–µ–≤–µ—Ç–∫–∞", es: "Camar√≥n", zh: "Ëôæ" },
            sardine: { en: "Sardine", ru: "–°–∞—Ä–¥–∏–Ω–∞", es: "Sardina", zh: "Ê≤ô‰∏ÅÈ±º" },
            carp: { en: "Golden Carp", ru: "–ö–∞—Ä–∞—Å—å", es: "Carpa dorada", zh: "ÈáëÈ≤§È±º" },
            perch: { en: "Perch", ru: "–û–∫—É–Ω—å", es: "Perca", zh: "È≤àÈ±º" },
            trout: { en: "Trout", ru: "–§–æ—Ä–µ–ª—å", es: "Trucha", zh: "È≥üÈ±º" },
            clown: { en: "Clownfish", ru: "–†—ã–±–∞-–∫–ª–æ—É–Ω", es: "Pez payaso", zh: "Â∞è‰∏ëÈ±º" },
            crab: { en: "King Crab", ru: "–ö—Ä–∞–±", es: "Cangrejo real", zh: "Â∏ùÁéãËüπ" },
            jelly: { en: "Jellyfish", ru: "–ú–µ–¥—É–∑–∞", es: "Medusa", zh: "Ê∞¥ÊØç" },
            squid: { en: "Squid", ru: "–ö–∞–ª—å–º–∞—Ä", es: "Calamar", zh: "È±øÈ±º" },
            seahorse: { en: "Seahorse", ru: "–ú–æ—Ä—Å–∫–æ–π –∫–æ–Ω–µ–∫", es: "Caballito de mar", zh: "Êµ∑È©¨" },
            pike: { en: "Pike", ru: "–©—É–∫–∞", es: "Lucio", zh: "ÁãóÈ±º" },
            eel: { en: "Electric Eel", ru: "–£–≥–æ—Ä—å", es: "Anguila el√©ctrica", zh: "ÁîµÈ≥ó" },
            tuna: { en: "Bluefin Tuna", ru: "–¢—É–Ω–µ—Ü", es: "At√∫n rojo", zh: "ËìùÈ≥çÈáëÊû™È±º" },
            sword: { en: "Swordfish", ru: "–†—ã–±–∞-–º–µ—á", es: "Pez espada", zh: "ÂâëÈ±º" },
            ray: { en: "Stingray", ru: "–°–∫–∞—Ç", es: "Raya", zh: "È≥êÈ±º" },
            catfish: { en: "Giant Catfish", ru: "–°–æ–º", es: "Bagre gigante", zh: "Â∑®ÂûãÈ≤∂È±º" },
            angler: { en: "Anglerfish", ru: "–£–¥–∏–ª—å—â–∏–∫", es: "Rape", zh: "ÈÆüÈ±áÈ±º" },
            turtle: { en: "Sea Turtle", ru: "–ß–µ—Ä–µ–ø–∞—Ö–∞", es: "Tortuga marina", zh: "Êµ∑Èæü" },
            shark: { en: "Great White", ru: "–ë–µ–ª–∞—è –ê–∫—É–ª–∞", es: "Gran tibur√≥n blanco", zh: "Â§ßÁôΩÈ≤®" },
            whale: { en: "Blue Whale", ru: "–°–∏–Ω–∏–π –ö–∏—Ç", es: "Ballena azul", zh: "ËìùÈ≤∏" },
            chest: { en: "Treasure Chest", ru: "–°—É–Ω–¥—É–∫", es: "Cofre del tesoro", zh: "ÂÆùÁÆ±" },
            mega: { en: "Megalodon", ru: "–ú–µ–≥–∞–ª–æ–¥–æ–Ω", es: "Megalod√≥n", zh: "Â∑®ÈΩøÈ≤®" },
            kraken: { en: "THE KRAKEN", ru: "–ö–†–ê–ö–ï–ù", es: "EL KRAKEN", zh: "Êµ∑ÊÄ™ÂÖãÊãâËÇØ" }
        };

        let currentLang = 'en'; 
        let state = { bal: 0, en: 100, rod: 1, boat: 0, p_rod: 0, p_boat: 0, bait_c: 0, bait_r: 0 };
        let isMuted = false; 
        let musicStarted = false;
        let isFishing = false;
        let lastCatchData = null; // –î–∞–Ω–Ω—ã–µ –¥–ª—è —à–∞—Ä–∏–Ω–≥–∞

        let currentTopType = 'balance';
        let currentTopPeriod = 'all';
        let currentShopTab = 'equip';

        function setLanguage(lang) {
            currentLang = lang;
            document.querySelectorAll('.flag-img').forEach(f => f.classList.remove('active'));
            document.getElementById('flag-' + lang).classList.add('active');
            document.querySelectorAll('[data-t]').forEach(el => {
                const key = el.getAttribute('data-t');
                if (translations[lang][key]) el.innerText = translations[lang][key];
            });
            render();
            renderShop();
            localStorage.setItem('fishing_lang', lang);
            
            const pageTop = document.getElementById('page-top');
            if(pageTop.style.display !== 'none' && pageTop.style.display !== '') {
                loadTop();
            }
        }

        const bgMusic = document.getElementById('bg-music');
        const sfxCatch = document.getElementById('sfx-catch');
        const sfxFail = document.getElementById('sfx-fail');
        bgMusic.volume = 0.15; sfxCatch.volume = 1.0; sfxFail.volume = 1.0;

        function toggleMute() {
            isMuted = !isMuted;
            document.getElementById('sound-btn').innerText = isMuted ? "üîá" : "üéµ";
            if (isMuted) bgMusic.pause();
            else if (musicStarted) bgMusic.play();
        }

        function playSound(type) {
            if (isMuted) return;
            if (!musicStarted && !isMuted) {
                bgMusic.play().catch(e => console.log("Auto-play blocked"));
                musicStarted = true;
            }
            const sound = (type === 'catch') ? sfxCatch : sfxFail;
            sound.currentTime = 0;
            sound.play();
        }

        function showAd() {
            if (!ADSGRAM_BLOCK_ID) { tg.showAlert("Adsgram ID loading..."); return; }
            if (!window.Adsgram) { tg.showAlert("Adsgram not loaded yet."); return; }
            const AdController = window.Adsgram.init({ blockId: ADSGRAM_BLOCK_ID });
            AdController.show().then(async (result) => {
                playSound('catch');
                try {
                    let res = await fetch('/api/ad_reward', { method: 'POST', body: JSON.stringify({telegram_id: uid}), headers: {'Content-Type': 'application/json'} });
                    let data = await res.json();
                    if(data.success) {
                        tg.showAlert(`+${data.reward} Coins & Full Energy!`);
                        updateState(data);
                    }
                } catch(e) { console.error(e); }
            }).catch((result) => {});
        }

        async function init() {
            const saved = localStorage.getItem('fishing_lang');
            const tgLang = tg.initDataUnsafe.user?.language_code; 
            if (saved) setLanguage(saved);
            else if (translations[tgLang]) setLanguage(tgLang); 
            else if (tgLang && tgLang.startsWith('zh')) setLanguage('zh'); 
            else setLanguage('en');

            try {
                let res = await fetch('/api/init', { 
                    method: 'POST', 
                    body: JSON.stringify({
                        telegram_id: uid, 
                        username: uname,
                        first_name: fname, 
                        last_name: lname
                    }), 
                    headers: {'Content-Type': 'application/json'} 
                });
                let data = await res.json();
                if (data.adsgram_id) ADSGRAM_BLOCK_ID = data.adsgram_id;
                updateState(data);
                if (data.offline_earned > 0) {
                    const t = translations[currentLang];
                    tg.showAlert(`${t.afk_income} ${data.offline_earned} ${t.coins}`);
                }
            } catch(e) { console.error(e); }                
        }

        // --- –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò ---
        function closePopup() {
            const popup = document.getElementById('catch-popup');
            popup.classList.remove('show');
            playSound('catch'); // –∑–≤—É–∫ –º–æ–Ω–µ—Ç–æ–∫
        }

        function shareCurrentCatch() {
            if (!lastCatchData) return;
            const query = `${lastCatchData.id}|${lastCatchData.weight}|${lastCatchData.rarity}`;
            tg.switchInlineQuery(query, ['users', 'groups']);
        }
        // ---------------------

        async function catchFish(e) {
            if (document.getElementById('catch-popup').classList.contains('show')) return;
            if (isFishing) return; 

            const t = translations[currentLang];
            if (state.en < 2) { 
                tg.HapticFeedback.notificationOccurred('warning');
                showFloat(e.clientX, e.clientY, "üí§", "#94a3b8");
                return; 
            }

            isFishing = true; 
            state.en = Math.max(0, state.en - 2); 
            render();

            const btn = document.getElementById('fish-btn');
            btn.style.transform = "scale(0.9)";
            setTimeout(() => btn.style.transform = "scale(1)", 100);

            try {
                let res = await fetch('/api/fish', { 
                    method: 'POST', body: JSON.stringify({telegram_id: uid}),
                    headers: {'Content-Type': 'application/json'}
                });
                let data = await res.json();
                
                if (data.status === "cooldown") {
                    isFishing = false;
                    return; 
                }

                state.bal = data.balance;
                state.en = data.energy; 
                if(data.bait_common !== undefined) state.bait_c = data.bait_common;
                if(data.bait_rare !== undefined) state.bait_r = data.bait_rare;
                render(); 

                if (data.afk_earned && data.afk_earned > 0) showFloat(e.clientX + 50, e.clientY - 50, `+${data.afk_earned} üö§`, "#60a5fa");

                if (data.status === "caught") {
                    playSound('catch');
                    tg.HapticFeedback.impactOccurred('medium');
                    
                    let fName = data.fish_id;
                    if (fishNames[data.fish_id] && fishNames[data.fish_id][currentLang]) {
                        fName = fishNames[data.fish_id][currentLang];
                    } else if (fishNames[data.fish_id]) fName = fishNames[data.fish_id]['en'];

                    const popup = document.getElementById('catch-popup');
                    const pImg = document.getElementById('popup-img');
                    const pTitle = document.getElementById('popup-title');
                    const pReward = document.getElementById('popup-reward');

                    pImg.src = `/static/images/${data.fish_id}.png`; 
                    pTitle.innerText = fName;

                    let weightText = "";
                    if (data.is_trash && data.fish_id !== 'chest') {
                        weightText = `1 ${translations[currentLang].unit_pc}`;
                    } else {
                        weightText = `${data.weight} ${translations[currentLang].unit_kg}`;
                    }
                    
                    pReward.innerHTML = `<span style="color:var(--gold)">+${data.reward} üí∞</span><br><span style="font-size:1.2rem; color:#cbd5e1">${weightText}</span>`;
                    
                    // –°–û–•–†–ê–ù–Ø–ï–ú –î–ê–ù–ù–´–ï
                    lastCatchData = {
                        id: data.fish_id,
                        weight: data.weight,
                        rarity: data.rarity || 1
                    };

                    popup.classList.add('show');
                    // –ê–í–¢–û–ó–ê–ö–†–´–¢–ò–ï –£–ë–†–ê–ù–û!

                    showFloat(e.clientX, e.clientY, `+${data.reward}`, data.fish_color);
                    
                    const balEl = document.getElementById('balance');
                    balEl.style.transform = "scale(1.15)";
                    setTimeout(() => balEl.style.transform = "scale(1)", 150);

                } else if (data.status === "miss") {
                    playSound('fail');
                    tg.HapticFeedback.notificationOccurred('error');
                    showFloat(e.clientX, e.clientY, t.miss, "#ef4444");
                } else {
                    showFloat(e.clientX, e.clientY, "üí§", "#94a3b8");
                }
            } catch (err) { 
                console.error(err); 
                state.en = Math.min(100, state.en + 2); 
            } finally {
                isFishing = false;
                render();
            }
        }

        async function buy(item) {
            let price = 0;
            if (item === 'rod') price = state.p_rod;
            else if (item === 'boat') price = state.p_boat;
            else if (CONSUMABLES_INFO[item]) price = CONSUMABLES_INFO[item].price;

            if (state.bal < price) { tg.HapticFeedback.notificationOccurred('error'); return; }

            let res = await fetch('/api/upgrade', { method: 'POST', body: JSON.stringify({telegram_id: uid, item_id: item}), headers: {'Content-Type': 'application/json'} });
            let data = await res.json();
            if (data.success) {
                playSound('catch');
                tg.HapticFeedback.notificationOccurred('success');
                tg.showAlert(translations[currentLang].buy_success);
                updateState(data);
            }
        }

        function switchShopTab(tabName, el) {
            currentShopTab = tabName;
            el.parentElement.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            renderShop();
            tg.HapticFeedback.selectionChanged();
        }

        function renderShop() {
            const list = document.getElementById('shop-list');
            list.innerHTML = "";
            const t = translations[currentLang];

            list.innerHTML += `
            <div class="card" style="border-color: rgba(34, 197, 94, 0.4); background: rgba(34, 197, 94, 0.1);">
                <div class="card-icon">‚ö°</div>
                <div class="card-info">
                    <div class="card-title">${t.ad_title}</div>
                    <div class="card-sub">${t.ad_desc}</div>
                </div>
                <button class="btn-ad" onclick="showAd()">${t.ad_btn}</button>
            </div>`;

            if (currentShopTab === 'equip') {
                const chance = 30 + (state.rod * 4);
                let btnRodText = state.p_rod ? `${state.p_rod.toLocaleString()} üí∞` : "MAX";
                let btnRodDisabled = (!state.p_rod || state.bal < state.p_rod) ? "disabled" : "";
                
                list.innerHTML += `
                <div class="card">
                    <div class="card-icon">üé£</div>
                    <div class="card-info">
                        <div class="card-title">${t.item_rod}</div>
                        <div class="card-sub">${t.lvl} ${state.rod} (${t.chance} ${chance}%)</div>
                    </div>
                    <button class="btn" onclick="buy('rod')" ${btnRodDisabled}>${btnRodText}</button>
                </div>`;

                let btnBoatText = state.p_boat ? `${state.p_boat.toLocaleString()} üí∞` : "MAX";
                let btnBoatDisabled = (!state.p_boat || state.bal < state.p_boat) ? "disabled" : "";
                let boatDesc = state.boat ? `${t.lvl} ${state.boat}` : t.none;

                list.innerHTML += `
                <div class="card">
                    <div class="card-icon">üö§</div>
                    <div class="card-info">
                        <div class="card-title">${t.item_boat}</div>
                        <div class="card-sub">${boatDesc}</div>
                    </div>
                    <button class="btn" onclick="buy('boat')" ${btnBoatDisabled}>${btnBoatText}</button>
                </div>`;

            } else {
                for (const [key, info] of Object.entries(CONSUMABLES_INFO)) {
                    const disabled = state.bal < info.price ? 'disabled' : '';
                    
                    list.innerHTML += `
                    <div class="card">
                        <div class="card-icon">${info.icon}</div>
                        <div class="card-info">
                            <div class="card-title">${t[info.name_key]}</div>
                            <div class="card-sub">${t[info.desc_key]}</div>
                        </div>
                        <button class="btn" onclick="buy('${key}')" ${disabled}>${info.price} üí∞</button>
                    </div>`;
                }
            }
        }

        async function switchTopType(type, el) {
            currentTopType = type;
            el.parentElement.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            await loadTop();
            tg.HapticFeedback.selectionChanged();
        }

        async function switchTopPeriod(period, el) {
            currentTopPeriod = period;
            el.parentElement.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
            await loadTop();
            tg.HapticFeedback.selectionChanged();
        }

        async function loadTop() {
            let list = document.getElementById('leaderboard-list');
            list.innerHTML = `<div style='color:#cbd5e1; margin-top:30px; text-align:center; font-weight:600;'>${translations[currentLang].loading}</div>`;
            try {
                let res = await fetch(`/api/leaderboard?type=${currentTopType}&period=${currentTopPeriod}`);
                let data = await res.json();
                list.innerHTML = "";
                
                if (data.leaderboard.length === 0) {
                    list.innerHTML = `<div style='color:#64748b; margin-top:30px; text-align:center; font-weight:600;'>${translations[currentLang].empty_list}</div>`;
                } else {
                    data.leaderboard.forEach((u, i) => {
                        let rankClass = "";
                        let rankIcon = i + 1;
                        if (i === 0) { rankClass = "rank-1"; rankIcon = "ü•á"; }
                        if (i === 1) { rankClass = "rank-2"; rankIcon = "ü•à"; }
                        if (i === 2) { rankClass = "rank-3"; rankIcon = "ü•â"; }

                        let valText = "";
                        if (currentTopType === 'balance') {
                            valText = u.value.toLocaleString() + " üí∞";
                        } else if (currentTopType === 'weight') {
                            valText = parseFloat(u.value).toFixed(1) + " " + translations[currentLang].unit_kg;
                        } else if (currentTopType === 'trash') {
                            valText = Math.floor(u.value) + " " + translations[currentLang].unit_pc;
                        }

                        list.innerHTML += `
                        <div class="leader-row ${rankClass}">
                            <div class="leader-left">
                                <div class="leader-rank">${rankIcon}</div>
                                <div style="color:white; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:140px;">${u.username}</div>
                            </div>
                            <div class="leader-val">${valText}</div>
                        </div>`;
                    });
                }

                const totalCountEl = document.getElementById('total-players-count');
                if (totalCountEl && data.total !== undefined) {
                    totalCountEl.innerText = `${translations[currentLang].total_players} ${data.total}`;
                }

            } catch(e) {
                console.error(e);
                list.innerHTML = `<div style='color:#ef4444; margin-top:30px; text-align:center;'>Error loading top</div>`;
            }
        }

        function updateState(data) {
            state.bal = data.balance;
            state.en = data.energy;
            state.rod = data.rod_level;
            state.boat = data.boat_level;
            state.p_rod = data.rod_price;
            state.p_boat = data.boat_price;
            if(data.bait_common !== undefined) state.bait_c = data.bait_common;
            if(data.bait_rare !== undefined) state.bait_r = data.bait_rare;
            
            render();
            renderShop();
        }

        function render() {
            const t = translations[currentLang];
            document.getElementById('balance').innerText = state.bal.toLocaleString();
            document.getElementById('shop-balance-footer').innerText = `${t.score_label}: ${state.bal.toLocaleString()} üí∞`;

            const enFill = document.getElementById('energy-fill');
            let c1 = '#3b82f6', c2 = '#60a5fa'; 
            if (state.en <= 50) { c1 = '#ca8a04'; c2 = '#facc15'; } 
            if (state.en <= 20) { c1 = '#dc2626'; c2 = '#ef4444'; } 
            enFill.style.width = state.en + "%";
            enFill.style.background = `linear-gradient(90deg, ${c1}, ${c2})`;
            if (state.en <= 20) enFill.style.boxShadow = "0 0 15px rgba(239, 68, 68, 0.8)";
            else enFill.style.boxShadow = "0 0 10px rgba(59, 130, 246, 0.5)";
            document.getElementById('energy-text').innerText = Math.floor(state.en) + "% " + t.energy_label;
            
            document.getElementById('inv-bait-common').innerText = state.bait_c;
            document.getElementById('inv-bait-rare').innerText = state.bait_r;
        }

        function tab(name, el) {
            document.querySelectorAll('.content').forEach(d => d.style.display = 'none');
            document.querySelectorAll('.nav-item').forEach(d => d.classList.remove('active'));
            document.getElementById('page-'+name).style.display = (name === 'top') ? 'flex' : (name === 'shop' ? 'flex' : 'flex');
            
            el.classList.add('active');
            
            const balContainer = document.getElementById('main-balance-display');
            if (name === 'top' || name === 'shop') {
                balContainer.style.display = 'none';
            } else {
                balContainer.style.display = 'block';
            }

            if(name === 'top') loadTop();
            if(name === 'shop') renderShop();
            tg.HapticFeedback.selectionChanged();
        }

        function showFloat(x, y, txt, color) {
            let el = document.createElement('div');
            el.className = 'float-text';
            el.style.left = x + "px"; el.style.top = y + "px";
            el.innerText = txt;
            el.style.color = color;
            document.body.appendChild(el);
            setTimeout(()=>el.remove(), 900);
        }

        setInterval(async () => {
            if (isFishing) return;
            if (document.getElementById('catch-popup').classList.contains('show')) return;
            try {
                let res = await fetch('/api/init', { 
                    method: 'POST', body: JSON.stringify({telegram_id: uid}), headers: {'Content-Type': 'application/json'}
                });
                let data = await res.json();
                updateState(data);
            } catch (e) { console.error("Sync error", e); }
        }, 4000); 

        init();
    </script>
</body>
</html>